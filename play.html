<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width-device-width, initial-scale:1.0">
  <title>Play! - Cookie Clicker</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="icon" href="cookie.svg" type="image/x-icon">
</head>
  <body class="noselect">
    <div class="contentFlex flexStart">
      <div class="header">
        <h1>Play!</h1>
      </div>
      <h4 class="hText">
        Click the cookie as fast as you can before the time runs out!
        <br />
        Think you can beat the 
        <a href="/app/leaderboard"><u>high score</u></a>? 
        Start clicking to play!
      </h4>
      <div class="gameBox">
        <div id="cookie" class="gameCookie splashLeft"></div>
        <div class="scoreColumn">
          <div class="countCell">
            <h2 id="scoreCount" class="hText inline">Cookies: 0</h2>
          </div>
          <div class="countCell">
            <h2 id="timer" class="hText inline">Time: 30</h2>
          </div>
          <div class="countCell">
            <h3 class="hText">High score: 32</h3>
          </div>
        </div>
      </div>
    </div>

    <div class="loginBox"><a href="/app/dashboard"><u>Back to dashboard</u></a></div>
  </div>
  
  <script>

    
    //Load this score variable and then call sendResults() to push the game results to the database
    var score = 0;
    
    //This gets the current users data from the userInfo table and stores it in currentUserInfo
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open("GET", '/app/getCurrentUser/', false);
    xmlHttp.send(null);
    //Current user info ******
    const currentUserInfo = JSON.parse(xmlHttp.responseText);
    console.log(currentUserInfo);
    //Current user's ID #
    var currId = currentUserInfo.id;
    var currUser = currentUserInfo.user;


    //TODO: Once the game ends we need to send the score to the database
    function sendResults() {
      console.log(currUser);
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("post", '/app/score/', false);
      xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xmlHttp.send("user="+currUser+"&score="+score);
      console.log(xmlHttp.responseText);
    }
    
      // Timer 
      var cookieButton = document.getElementById("cookie"); 
      cookieButton.addEventListener("click", countdown, {once : true}); 
      cookieButton.addEventListener("click", incrementScore); 
      var score = 0; 
      // Countdown function, when time <= 0, countdown returns false 
      function countdown() {
        var seconds = 3; 
        timerDone = true; 
        score = 0; 
        var counter = setInterval(function() {
          seconds--; 
          document.getElementById("timer").innerHTML = "Time: " + seconds;  
          if (seconds <= 0) {
            clearInterval(counter); 
            alert("Out of time"); 
            sendResults(); 
            cookieButton.removeEventListener("click", countdown, {once : true}); 
            cookieButton.addEventListener("click", countdown, {once : true}); 
            score = 0; 
            document.getElementById("timer").innerHTML = "Time: 30"; 
            document.getElementById("scoreCount").innerHTML = "Cookies: 0"; 
            return false;  
          }
        }, 1000);
      };
      function incrementScore() {
        score += 1; 
        document.getElementById("scoreCount").innerHTML = "Cookies: " + score; 
      }; 
    
    
  </script>
</body>

</html>